buildvariants:
  - display_name: Ubuntu 18.04
    name: ubuntu1804
    run_on:
      - ubuntu1804-small
    tasks:
      - name: unit_tests

  - display_name: OSX
    name: osx
    run_on:
      - macos-1015
    tasks:
      - name: unit_tests

  - display_name: Windows
    name: windows
    run_on:
      - windows-vsCurrent-small
    expansions:
      exe: ".exe"
      content_type: application/zip
      compile_flags: --dbg=on --opt=on --win-version-min=win10 -j$(bc <<< "$(grep -c '^processor' /proc/cpuinfo) / 1.5") MONGO_DISTMOD=windows
      num_scons_link_jobs_available: 0.25
      python: '/cygdrive/c/python/python37/python.exe'
      ext: zip
    tasks:
      - name: unit_tests

functions:
  create virtualenv:
    - command: subprocess.exec
      params:
        working_dir: evg-module-manager
        binary: bash
        args: ["src/evergreen_dir/venv_setup.sh"]


pre:
- command: git.get_project
  params:
    directory: src
- func: create virtualenv

post:
- command: attach.xunit_results
  params:
    file: src/junit-*.xml

tasks:
- name: unit_tests
  commands:
  - command: shell.exec
    params:
      working_dir: src
      script: |
        set -o errexit
        set -o verbose

        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8

        . venv/bin/activate

        poetry run pytest --cov=src --junitxml=junit-test-output.xml

- name: evg_module_manager_install
  commands:
  - command: shell.exec
    params:
      working_dir: src
      script: |
        set -o errexit
        set -o verbose

        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8

        /opt/mongodbtoolchain/v3/bin/python3 -m venv emm-cli-venv
        . emm-cli-venv/bin/activate

        pip install --upgrade pip
        pip install .

        evg-module-manager --help
